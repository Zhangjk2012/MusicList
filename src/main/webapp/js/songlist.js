var datagrid;var songListSelect;$(function(){datagrid=$("#songlistlist").datagrid({url:"admin/songlistlist",isField:"id",pagination:true,rownumbers:true,fit:true,fitColumns:true,singleSelect:true,frozenColumns:[[{field:"ck",checkbox:true}]],columns:[[{field:"id",title:"id",hidden:true,width:100},{field:"name",title:"榜单名称",width:100},{field:"enable",title:"是否启用",width:100,formatter:function(D,C){if(D==undefined){return""}var B;if(D===true){B="启用"}else{B="禁用"}return B}},{field:"picture",title:"类别图片",width:100,formatter:function(C,B){if(C==undefined||C==""){return""}return'<img width=30 height=30 src="'+B.picture+'" alt="类别图片" />'}}]],onClickRow:function(C,B){showSongs(B.id)},toolbar:[{text:"增加",iconCls:"icon-add",handler:function(){winOpen()}},"-",{text:"删除",iconCls:"icon-remove",handler:function(){var B=datagrid.datagrid("getSelected");if(B<=0){$.messager.alert("警告","您没有选择","error")}else{$.messager.confirm("确定","您确定要删除吗",function(C){if(C){$.ajax({url:"admin/deleteSongList",data:B,method:"post",dataType:"json",success:function(D){if(D.success){$.messager.show({msg:"删除成功。",title:"成功"});datagrid.datagrid("reload")}else{$.messager.alert("错误","删除失败。","error")}}})}})}}},"-",{text:"修改",iconCls:"icon-edit",handler:function(){var B=datagrid.datagrid("getSelected");if(B<=0){$.messager.alert("警告","您没有选择","error")}else{winUpdateOpen(B)}}},"-",{text:"添加榜单歌曲",iconCls:"icon-add",handler:function(){var B=datagrid.datagrid("getSelected");if(B<=0){$.messager.alert("警告","您没有选择","error")}else{songListSelect=B.id;$("#songListWin").window("open")}}}]});var A=$("#songlistlist").datagrid("getPager");$(A).pagination({pageSize:20,pageList:[20],beforePageText:"第",afterPageText:"页    共 {pages} 页",displayMsg:"当前显示 {from} - {to} 条记录   共 {total} 条记录"});$("#songlist").datagrid({isField:"id",title:"专辑所有音乐",pagination:false,rownumbers:true,loadMsg:"Loading...",fit:true,fitColumns:true,singleSelect:true,frozenColumns:[[{field:"ck",checkbox:true}]],columns:[[{field:"id",title:"id",hidden:true},{field:"songListId",title:"songListId",hidden:true},{field:"songOrder",title:"歌曲排序",width:50,editor:{type:"numberbox",options:{"min":1,"max":10}}},{field:"songName",title:"歌曲名称",width:50},{field:"singerName",title:"歌手",width:50},{field:"albumName",title:"专辑",width:50},{field:"songFlag",title:"MP3/MP4",width:50,formatter:function(D,C){if(D==undefined){return""}var B;if(D===true){B="MP3"}else{B="MP4"}return B}},{field:"briefIntroduction",title:"歌曲简介",width:50,formatter:function(E,D){if(E==undefined||E==""){return""}var B="";if(E.length>20){B=E.substr(0,20)+"..."}else{B=E}var C='<span title="'+E+'" class="note">'+B+"</span>";return C}},{field:"picture",title:"歌曲图片",width:50,formatter:function(C,B){if(C==undefined||C==""){return""}return'<img width=30 height=30 src="'+B.picture+'" alt="歌曲图片" />'}},]],onDblClickRow:onDblClickRow,onEndEdit:onEndEdit,onLoadSuccess:function(B){$(".note").tooltip({onShow:function(){$(this).tooltip("tip").css({width:"300",boxShadow:"1px 1px 3px #292929"})}})},toolbar:[{text:"删除音乐",iconCls:"icon-remove",handler:function(){var B=$("#songlist").datagrid("getSelected");if(B<=0){$.messager.alert("警告","您没有选择","error")}else{$.messager.confirm("确定","您确定要删除吗",function(C){if(C){if(editIndex!=undefined){$("#songlist").datagrid("cancelEdit",editIndex);editIndex=undefined}$.ajax({url:"admin/deleteSongListSong",data:{songId:B.id},method:"post",dataType:"json",success:function(D){if(D.success){$.messager.show({msg:"删除成功。",title:"成功"});$("#songlist").datagrid("reload")}else{$.messager.alert("错误","删除失败。","error")}}})}})}}},"-",{text:"保存编辑",iconCls:"icon-save",handler:accept,},"-",{text:"取消编辑",iconCls:"icon-undo",handler:reject,},"-",{text:"提交保存",iconCls:"icon-undo",handler:submitOrder,}]});$("#selectsonglist").datagrid({isField:"id",pagination:true,rownumbers:true,loadMsg:"Loading...",fit:true,fitColumns:true,singleSelect:false,toolbar:"#tb",frozenColumns:[[{field:"ck",checkbox:true}]],columns:[[{field:"songName",title:"歌曲名称",width:50},{field:"singerName",title:"歌手",width:50},{field:"albumName",title:"专辑",width:50},{field:"songFlag",title:"MP3/MP4",width:50,formatter:function(D,C){if(D==undefined){return""}var B;if(D===true){B="MP3"}else{B="MP4"}return B}}]],onLoadSuccess:function(B){$(".note").tooltip({onShow:function(){$(this).tooltip("tip").css({width:"300",boxShadow:"1px 1px 3px #292929"})}})}});$("#songListWin").window({width:800,height:600,modal:true,closed:true,resizable:false,minimizable:false,maximizable:false,collapsible:false,footer:"#songListWinFooter",onBeforeClose:function(){},onOpen:function(){$("#selectsonglist").datagrid({url:"admin/getselectsonglistsongs"}).datagrid("getPager").pagination({pageSize:50,pageList:[20,50,100],beforePageText:"第",afterPageText:"页    共 {pages} 页",displayMsg:"当前显示 {from} - {to} 条记录   共 {total} 条记录"})}});$("#win").window({width:500,height:300,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,footer:"#addFooter",onBeforeClose:function(){clearForm()}});createImgUpload("file_upload","fileQueue",function(B,C){$("#picture").val(C);$("#img").attr("src",C)});createImgUpload("update_upload","updateQueue",function(B,C){$("#updatePicture").val(C);$("#updateImg").attr("src",C)});$("#updateWin").window({width:500,height:300,modal:true,closed:true,minimizable:false,maximizable:false,collapsible:false,footer:"#updateFooter",onBeforeClose:function(){clearUpdateForm()}})});function submitForm(){$("#songlistform").form("submit",{onSubmit:function(){return $(this).form("enableValidation").form("validate")},success:function(A){$.messager.show({msg:"添加成功。",title:"成功"});$("#win").window("close");$("#songlistlist").datagrid("reload")}})}function clearForm(){$("#songlistform").form("reset");clearUploadFile("file_upload");$("#img").attr("src","")}function closeWin(){$("#win").window("close");$("#img").attr("src","")}function winOpen(){$("#win").window("open")}function clearUplaoder(){clearUploadFile("file_upload");$("#picture").val("");$("#img").attr("src","")}function submitUpdateForm(){$("#updateform").form("submit",{onSubmit:function(){return $(this).form("enableValidation").form("validate")},success:function(A){$.messager.show({msg:"修改成功。",title:"成功"});$("#updateWin").window("close");$("#songlistlist").datagrid("reload")}})}function clearUpdateForm(){$("#updateform").form("reset");clearUploadFile("update_upload");$("#updateImg").attr("src","")}function closeUpdateWin(){$("#updateWin").window("close");$("#updateImg").attr("src","")}function winUpdateOpen(A){$("#updateWin").window("open");$("#updateform").form("load",A);$("#updateImg").attr("src",A.picture)}function clearUpdateUplaoder(){clearUploadFile("update_upload");$("#updatePicture").val("");$("#updateImg").attr("src","")}function showSongs(A){$("#songlist").datagrid({url:"admin/getSongListSongs",queryParams:{songListId:A}})}function searchSongs(){$("#selectsonglist").datagrid({queryParams:{"songName":$("#songName").val()}})}function addSongsOK(){var B=$("#selectsonglist").datagrid("getSelections");if(B<=0){$("#songName").textbox("clear");$("#songListWin").window("close")}else{var C=new Array();for(var A=0;A<B.length;A++){C.push(B[A].id)}$.ajax({url:"admin/addSongs2SongList",data:{songsId:C,songListId:songListSelect},type:"post",cache:false,dataType:"json",success:function(D){if(D===true){$.messager.show({msg:"添加成功。",title:"成功"});$("#songlist").datagrid("reload")}else{$.messager.show({msg:"添加失败。",title:"失败"})}},error:function(){alert("异常！")}})}$("#songName").textbox("clear");$("#songListWin").window("close")}function cancelAddSong(){$("#songName").textbox("clear");$("#songListWin").window("close")}var editIndex=undefined;function endEditing(){if(editIndex==undefined){return true}if($("#songlist").datagrid("validateRow",editIndex)){$("#songlist").datagrid("endEdit",editIndex);editIndex=undefined;return true}else{return false}}function onDblClickRow(C,B){if(editIndex!=C){if(endEditing()){$("#songlist").datagrid("selectRow",C).datagrid("beginEdit",C);var A=$("#songlist").datagrid("getEditor",{index:C,field:"songOrder"});if(A){($(A.target).data("textbox")?$(A.target).textbox("textbox"):$(A.target)).focus()}editIndex=C}else{setTimeout(function(){$("#songlist").datagrid("selectRow",editIndex)},0)}}}function onEndEdit(C,B){var A=$("#songlist").datagrid("getEditor",{index:C,field:"songOrder"});B.songOrder=$(A.target).numberbox("getValue")}function accept(){if(endEditing()){$("#songlist").datagrid("acceptChanges")}}function reject(){$("#songlist").datagrid("rejectChanges");editIndex=undefined}function submitOrder(){if(endEditing()){var B=$("#songlist").datagrid("getRows");var A={};$(B).each(function(C,D){if(D.songOrder!=""){A[D.songListId]=D.songOrder}});$.ajax({url:"admin/listSongOrder",data:A,type:"post",cache:false,dataType:"json",success:function(C){if(C.success===true){$.messager.show({msg:"修改成功。",title:"成功"});$("#songlist").datagrid("reload")}else{$.messager.show({msg:"修改失败。",title:"失败"})}},error:function(){alert("异常！")}})}};